{% extends "base.html" %}
{% block title %}Register{% endblock %}
{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <h2 class="text-center mb-4">Register</h2>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form method="POST" id="registerForm">
        <div class="mb-3">
          <label class="form-label">Username:</label>
          <input type="text" class="form-control" name="username" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Password:</label>
          <input type="password" class="form-control" id="password" name="password" required>
        </div>

        <!-- Realtime validation rules -->
        <div class="text-white mb-3">
          <p class="mb-1">Your password must include:</p>
          <ul class="list-unstyled ms-3">
            <li id="length" class="text-danger">❌ At least 8 characters</li>
            <li id="uppercase" class="text-danger">❌ An uppercase letter</li>
            <li id="lowercase" class="text-danger">❌ A lowercase letter</li>
            <li id="number" class="text-danger">❌ A number</li>
            <li id="special" class="text-danger">❌ A special character</li>
          </ul>
        </div>

        <button type="submit" class="btn btn-primary w-100">Register</button>
      </form>

      <p class="mt-3 text-center">Already have an account? <a href="{{ url_for('login') }}" class="link-light">Login here</a></p>
    </div>
  </div>
</div>

<script>
const passwordInput = document.getElementById("password");
const form = document.getElementById("registerForm");

function validatePassword(password) {
  return {
    length: password.length >= 8,
    uppercase: /[A-Z]/.test(password),
    lowercase: /[a-z]/.test(password),
    number: /[0-9]/.test(password),
    special: /[\W_]/.test(password),
  };
}

function updateValidationUI(rules) {
  for (const [rule, valid] of Object.entries(rules)) {
    const el = document.getElementById(rule);
    el.textContent = `${valid ? "✅" : "❌"} ${el.textContent.slice(2)}`;
    el.classList.toggle("text-danger", !valid);
    el.classList.toggle("text-success", valid);
  }
}

passwordInput.addEventListener("input", function () {
  const rules = validatePassword(this.value);
  updateValidationUI(rules);
});

// Prevent form submission if password is invalid
form.addEventListener("submit", function (e) {
  const pwd = passwordInput.value;
  const rules = validatePassword(pwd);
  const allValid = Object.values(rules).every(Boolean);

  if (!allValid) {
    e.preventDefault();
    alert("❌ Password does not meet all requirements.");
  }
});
</script>
{% endblock %}